name: Deploy API

on:
  push:
    branches: [main]
    paths:
      - 'EstudaZen/src/**'
      - 'EstudaZen/common.props'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          include-prerelease: true

      - name: Restore dependencies (API)
        run: dotnet restore EstudaZen/src/EstudaZen.HttpApi.Host/EstudaZen.HttpApi.Host.csproj

      - name: Restore dependencies (DbMigrator)
        run: dotnet restore EstudaZen/src/EstudaZen.DbMigrator/EstudaZen.DbMigrator.csproj

      - name: Install ABP CLI
        run: dotnet tool install -g Volo.Abp.Cli

      - name: Install ABP Libs
        run: abp install-libs
        working-directory: EstudaZen/src/EstudaZen.HttpApi.Host

      - name: Build API
        run: dotnet build EstudaZen/src/EstudaZen.HttpApi.Host/EstudaZen.HttpApi.Host.csproj -c Release --no-restore

      - name: Build DbMigrator
        run: dotnet build EstudaZen/src/EstudaZen.DbMigrator/EstudaZen.DbMigrator.csproj -c Release --no-restore

      - name: Publish API
        run: dotnet publish EstudaZen/src/EstudaZen.HttpApi.Host/EstudaZen.HttpApi.Host.csproj -c Release --no-build -o ./publish-api

      - name: Publish DbMigrator
        run: dotnet publish EstudaZen/src/EstudaZen.DbMigrator/EstudaZen.DbMigrator.csproj -c Release --no-build -o ./publish-migrator

      - name: Restore OpenIddict Certificate
        run: |
          echo "${{ secrets.OPENIDDICT_CERTIFICATE }}" | base64 --decode > ./publish-api/openiddict.pfx
          echo "${{ secrets.OPENIDDICT_CERTIFICATE }}" | base64 --decode > ./publish-migrator/openiddict.pfx

      - name: Create appsettings.Production.json for API
        run: |
          cat > ./publish-api/appsettings.Production.json << 'EOF'
          {
            "App": {
              "SelfUrl": "https://educa.zensuite.com.br",
              "AngularUrl": "https://educa.zensuite.com.br",
              "CorsOrigins": "https://educa.zensuite.com.br,http://localhost:4200",
              "RedirectAllowedUrls": "https://educa.zensuite.com.br,http://localhost:4200",
              "DisablePII": true,
              "HealthCheckUrl": "/health-status",
              "HealthUiCheckUrl": "https://educa.zensuite.com.br/health-status"
            },
            "ConnectionStrings": {
              "Default": "Host=localhost;Port=5432;Database=EstudaZen;User ID=educazen;Password=EducaZen@2024!Prod;"
            },
            "AuthServer": {
              "Authority": "https://educa.zensuite.com.br",
              "RequireHttpsMetadata": false,
              "SwaggerClientId": "EstudaZen_Swagger",
              "CertificatePassPhrase": "7a4979bb-93a4-4558-a79c-37a770212923"
            },
            "Redis": {
              "Configuration": "localhost:6379"
            },
            "StringEncryption": {
              "DefaultPassPhrase": "EducaZenProd2024Key"
            }
          }
          EOF

      - name: Create appsettings.json for DbMigrator
        run: |
          cat > ./publish-migrator/appsettings.json << 'EOF'
          {
            "ConnectionStrings": {
              "Default": "Host=localhost;Port=5432;Database=EstudaZen;User ID=educazen;Password=EducaZen@2024!Prod;"
            },
            "OpenIddict": {
              "Applications": {
                "EstudaZen_App": {
                  "ClientId": "EstudaZen_App",
                  "RootUrl": "https://educa.zensuite.com.br"
                },
                "EstudaZen_Swagger": {
                  "ClientId": "EstudaZen_Swagger",
                  "RootUrl": "https://educa.zensuite.com.br/"
                }
              }
            }
          }
          EOF

      - name: Copy wwwroot libs to publish
        run: |
          if [ -d "EstudaZen/src/EstudaZen.HttpApi.Host/wwwroot/libs" ]; then
            cp -r EstudaZen/src/EstudaZen.HttpApi.Host/wwwroot/libs ./publish-api/wwwroot/libs
          fi

      - name: Copy API files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "publish-api/*"
          target: "/opt/educazen/deploy-temp"
          strip_components: 1

      - name: Copy DbMigrator to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "publish-migrator/*"
          target: "/opt/educazen/migrator"
          strip_components: 1

      - name: Run DbMigrator and Deploy API
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Configurar PATH para dotnet
            export PATH="$HOME/.dotnet:$PATH"
            export DOTNET_ROOT="$HOME/.dotnet"
            
            # Parar API
            systemctl stop educazen-api || true
            
            # Executar DbMigrator (migrations + seeds)
            echo "Running DbMigrator..."
            cd /opt/educazen/migrator
            chmod +x EstudaZen.DbMigrator || true
            
            # Usar caminho completo ou PATH configurado
            $HOME/.dotnet/dotnet EstudaZen.DbMigrator.dll 2>&1 | tee /opt/educazen/migrator-output.log
            MIGRATOR_RESULT=${PIPESTATUS[0]}
            
            # Verificar se o migrator rodou com sucesso
            if [ $MIGRATOR_RESULT -ne 0 ]; then
              echo "DbMigrator failed with exit code: $MIGRATOR_RESULT"
              cat /opt/educazen/migrator-output.log
              exit 1
            fi
            
            echo "DbMigrator completed successfully."
            
            # Limpar e mover arquivos da API
            rm -rf /opt/educazen/api/*
            mv /opt/educazen/deploy-temp/* /opt/educazen/api/
            rm -rf /opt/educazen/deploy-temp
            
            # Iniciar API
            systemctl start educazen-api
            
            # Aguardar e verificar
            sleep 5
            systemctl status educazen-api --no-pager
